IHTSDO Snomed Publication Tools
===============================

Test
----

This is a sanity test for the canonical algorithm results. The application reads in 3 ontologies:
- The original, unmodified long form format used as inputs for the canonical algorithm ("original")
- The generated, short form output from the canonical algorithm ("generated")
- The expected, short form output from the legacy PL/SQL version of the canonical algorithm ("expected")

This sanity tests then compares the "expected" triple set against the "generated" triple set, and tries to identify any discrepancies between these. Ideally, the two outputs would be identical. 

We then do a number of error checks on the "generated" and "expected" output, using the "original" input ontology, to see if any of the "generated" or "expected" statements are erroneous, and if so, why.

We noticed during our testing that several problems exists with the legacy PL/SQL algorithm:
- There are several isA statements in the isA output that should not be there. This error exists **only** in the most recent release of the PL/SQL algorithm
- There are some 14,000 unshared defining characteristic statements in the "expected' output that are erroneous. This error seems to go back at least 2 releases of the PL/SQL algorithm. 

When you run this program, you have the option of using either a disk based embedded database (H2), or an in-memory database. The disk based database is slower to use, but has a smaller memory footprint. The in-memory database requires about 6Gb of heap space ('-Xmx6000m').

You will need to have the Java 7 JDK and Maven 3 to build the distribution jar file, and Java 7 JRE in order to run it.

To build the distribution, enter the root project directory (on up from this folder) and type:

    mvn clean package

The distribution jar file can be found at test/target/test.jar after this. No other file is required in order to run the program, and can be distributed as this single file.

For help on how to run the program, type:

    java -jar test.jar -h

You will then see this output:

     -h, --help       Print this help menu
     -g. --generated  File containing all statements generated by algorithm
     -e, --expected   File containing all statements expected by algorithm
     -c, --concepts   File containing all the concepts referenced in the relationships file, aka 'Concepts_Core'
     -d, --database   Optional. Specify location of database file. If not specified, 
                      defaults to an in-memory database (minium 2Gb of heap space required)
     -x, --extra      Specify output file to write all the statements in generated, but not in expected
     -m, --missing    Specify output file to write all the statements in expected, but not in generated
     -o, --original   File containing the original long form relatioship statements, used to generate the canonical form

For example, to launch with an in-memory database, use this command:

    java -Xmx6000m -jar target/test.jar -g generated.txt -e expected.txt -c concepts.txt -x extras.txt -m missing.txt -o original.txt 
    
Don't forget the '-Xmx=6000m' option, or the program will not complete.

Or, to launch with a disk backed database, you can use this command, requiring only a minimum amount of heap space:

    java -Xmx6000m -jar target/test.jar -g generated.txt -e expected.txt -c concepts.txt -x extras.txt -m missing.txt -o original.txt -d /tmp/test.tmp.db
    
Warning! Using s disc backed database like this will make the program very slow, and might take a long time to complete.

The output from the console will look something like this:

    Using an in-memory database
    Initialising database
    Populating database
    Populating concepts for ontology [Original(1)]
    Populated [396109] concepts
    Populating relationships for ontology [Original(1)]
    Populated [1446149] relationships
    Creating isA hierarchy
    Created [539711] isA relationships
    Completed import in 29 seconds
    Populating database
    Populating concepts for ontology [Expected(2)]
    Populated [396109] concepts
    Populating relationships for ontology [Expected(2)]
    Populated [721487] relationships
    Creating isA hierarchy
    Created [434199] isA relationships
    Completed import in 14 seconds
    Populating database
    Populating concepts for ontology [Generated(3)]
    Populated [396109] concepts
    Populating relationships for ontology [Generated(3)]
    Populated [706374] relationships
    Creating isA hierarchy
    Created [434198] isA relationships
    Completed import in 20 seconds
    Starting sanity check
    Total number of expected statements: 712574
    Total number of generated statements: 698299
    Total number of original statements: 1446149
    Comparing the inputs
    Found [434197] generated isKindOf statements
    Found [434198] expected isKindOf statements
    Found [264102] generated udc statements
    Found [278376] expected udc statements
    There are [1] missing isA statements
    There are [0] extra isA statements
    There are [14274] missing unshared defining characteristic statements
    There are [0] extra unshared defining characteristic statements
    Writing all extra statements to extras.txt
    Wrote 1 lines
    Writing all missing statements to missing.txt
    Wrote 14276 lines
    Finding errors
    Objects of isA statements in the expected output, _must_ also appear as objects of isA statements in the input
    Number of IsA statements in the expected output in violation of this : 0
    Objects of udc statements in the expected output, _must_ also appear as objects of udc statements in the input
    Number of udc statements in the expected output in violation of this : 0
    Number of udc statements that are not charateristic types: 0
    For all missing udc statements, check if udc exists in primitive parent concept
    Found expected [14274] udc statements already defined in a primitive parent subject concept as a characteristic type
    Completed sanity check in 125 seconds
    Closing database
    Overall program completion in 193 seconds
    


